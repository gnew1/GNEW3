
<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>GNEW · Panel de cobros (N322)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
      input, button { padding: 8px; border-radius: 8px; }
      button { background:#111; color:#fff; border:0; cursor:pointer; }
      pre { background:#f6f7fb; padding:12px; border-radius:8px; }
    </style>
  </head>
  <body>
    <h2>Panel de cobros</h2>
    <div class="card">
      <h3>Vigilar suscripción</h3>
      <input id="sid" placeholder="subId" />
      <button onclick="watch()">Añadir</button>
      <pre id="out"></pre>
    </div>
    <div class="card">
      <h3>Scan manual</h3>
      <button onclick="scan()">Escanear y encolar</button>
      <pre id="scanOut"></pre>
    </div>
    <div class="card">
      <h3>Métricas</h3>
      <button onclick="metrics()">Refrescar</button>
      <pre id="metrics"></pre>
    </div>
    <script>
      const base = location.origin;
      async function watch(){
        const subId = Number(document.getElementById('sid').value);
        const r = await fetch(base + "/watch",{ method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify({ subId })});
        document.getElementById('out').textContent = JSON.stringify(await r.json(), null, 2);
      }
      async function scan(){
        const r = await fetch(base + "/scan",{ method:"POST" });
        document.getElementById('scanOut').textContent = JSON.stringify(await r.json(), null, 2);
      }
      async function metrics(){
        const r = await fetch(base + "/metrics");
        document.getElementById('metrics').textContent = JSON.stringify(await r.json(), null, 2);
      }
    </script>
  </body>
</html>


Notas de uso (breves):

Desplegar contrato: pnpm --filter @gnew/subscription-aa run build && hardhat test. Luego desplegar Subscription y setear SUBSCRIPTION_ADDRESS en el .env del servicio.

Backend: pnpm --filter @gnew/billing-aa-service dev (requiere NETWORK_RPC y opcionalmente BUNDLER_RPC para AA).

Alta/baja/prorrateo en cadena mediante subscribe(planId, anchorTs, prorate) y cancel/pause/resume.

Idempotencia: chargedCycle[subId][cycleIndex] evita dobles cobros; scheduler evita duplicados por job; reintentos con backoff exponencial.

Seguridad/observabilidad: límites diarios en scheduler, roles de collector, eventos on-chain, métricas /metrics.

DoD: tests on-chain cubren prorrateo, idempotencia y fallbacks; tests backend cubren backoff. Tasa de éxito >99% esperada con maxRetries adecuados.

Siguiente a ejecutar en la próxima interacción: N323 (Ledger doble-entrada auditable).

