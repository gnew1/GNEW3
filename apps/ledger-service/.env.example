
PORT=8093
DATABASE_URL=vault://kv/data/apps/ledger-service/db-url
VAULT_ADDR=http://127.0.0.1:8200
VAULT_TOKEN=
LOG_LEVEL=info
APPLY_TRIGGERS=true

# SSO (opcional)
JWT_AUDIENCE=gnew
JWT_ISSUER=https://sso.example.com/
JWT_PUBLIC_KEY="-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----"


Notas de uso mínimas:

Migraciones: pnpm --filter @gnew/ledger-service build && pnpm --filter @gnew/ledger-service start (ejecuta migraciones al arrancar). Para entornos de test sin plpgsql, usar APPLY_TRIGGERS=false.

API clave:

POST /accounts (role ledger:write)

POST /journal/entries (role ledger:write) — crea asientos en draft (valida que deb=cred).

POST /journal/entries/:id/post (role ledger:write) — publica asientos; respeta period lock y balance (DB trigger si activo).

POST /periods/:ym/lock (role ledger:admin) — bloquea YYYY-MM.

GET /balances/trial?asOf=YYYY-MM-DD (role ledger:read) — total deb/cred y diferencia (0 si balanceado).

POST /reconcile/auto (role ledger:write) — ingiere evento externo y lo matchea por txid o (amount, external_ref).

GET /export/xbrl?period=YYYY-MM (role ledger:read) — XBRL 2.1 simple con saldos.

Trazabilidad: txid/chain por línea; vista v_account_balances_month; reconciliaciones en gl_reconciliations.

Siguiente a ejecutar en la próxima interacción: N324 (Monitor AML/ATF en tiempo real).

